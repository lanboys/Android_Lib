<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>HTTP权威指南 (图灵程序设计丛书)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos356109" class="calibre_"><span class="calibre3"><span class="bold">5.2　最小的 Perl Web 服务器</span></span></p><p class="calibre_">要构建一个特性完备的 HTTP 服务器，是需要做一些工作的。Apache Web 服务器的内核有超过 50 000 行的代码，那些可选处理模块的代码量更是远远超过这个数字。</p><p class="calibre_">这个软件所要做的就是支持 HTTP/1.1 的各种特性：丰富的资源支持、虚拟主机、访问控制、日志记录、配置、监视和性能特性。在这里，可以用少于 30 行的 Perl 代码来创建一个最小的可用 HTTP 服务器。我们来看看这是怎么实现的。</p><p class="calibre_">例 5-1 显示了一个名为 type-o-serve 的小型 Perl 程序。这个程序是个很有用的诊断工具，可以用来测试与客户端和代理的交互情况。与所有 Web 服务器一样，type-o-serve 会等待 HTTP 连接。只要 type-o-serve 收到了请求报文，就会将报文打印在屏幕上，然后等待用户输入（或粘贴）一条响应报文，并将其回送给客户端。通过这种方式，type-o-serve 假扮成一台 Web 服务器，记录下确切的 HTTP 请求报文，并允许用户回送任意的 HTTP 响应报文。</p><p class="calibre_">这个简单的 type-o-serve 实用程序并没有实现大部分的 HTTP 功能，但它是一种很有用的工具，产生服务器响应报文的方式与 Telnet 产生客户端请求报文的方式相同（参见例 5-1）。可以从 <a href="http://www.http-guide.com/tools/type-o-serve.pl">http://www.http-guide.com/tools/type-o-serve.pl</a> 上下载 type-o-serve 程序。</p><blockquote class="calibre_21"><span class="bold">例 5-1</span>　type-o-serve——用于 HTTP 调试的最小型 Perl Web 服务器</blockquote><blockquote class="calibre_21"><span class="calibre7"><tt class="calibre8">#!/usr/bin/perl<br class="calibre2"/><br class="calibre2"/>use Socket;<br class="calibre2"/>use Carp;<br class="calibre2"/>use FileHandle;<br class="calibre2"/><br class="calibre2"/># (1) use port 8080 by default, unless overridden on command line<br class="calibre2"/>$port = (@ARGV ? $ARGV[0] : 8080);<br class="calibre2"/><br class="calibre2"/># (2) create local TCP socket and set it to listen for connections<br class="calibre2"/>$proto = getprotobyname('tcp');<br class="calibre2"/>socket(S, PF_INET, SOCK_STREAM, $proto) || die;<br class="calibre2"/>setsockopt(S, SOL_SOCKET, SO_REUSEADDR, pack("l", 1)) || die;<br class="calibre2"/>bind(S, sockaddr_in($port, INADDR_ANY)) || die;<br class="calibre2"/>listen(S, SOMAXCONN) || die;<br class="calibre2"/><br class="calibre2"/># (3) print a startup message<br class="calibre2"/>printf("    &lt;&lt;&lt;Type-O-Serve Accepting on Port %d&gt;&gt;&gt;\n\n",$port);<br class="calibre2"/><br class="calibre2"/>while (1)<br class="calibre2"/>{<br class="calibre2"/>    # (4) wait for a connection C<br class="calibre2"/>    $cport_caddr = accept(C, S);<br class="calibre2"/>    ($cport,$caddr) = sockaddr_in($cport_caddr);<br class="calibre2"/>    C-&gt;autoflush(1);<br class="calibre2"/><br class="calibre2"/>    # (5) print who the connection is from<br class="calibre2"/>    $cname = gethostbyaddr($caddr,AF_INET);<br class="calibre2"/>    printf("    &lt;&lt;&lt;Request From '%s'&gt;&gt;&gt;\n",$cname);<br class="calibre2"/><br class="calibre2"/>    # (6) read request msg until blank line, and print on screen<br class="calibre2"/>    while ($line = &lt;C&gt;)<br class="calibre2"/>    {<br class="calibre2"/>        print $line;<br class="calibre2"/>        if ($line =~ /^\r/) { last; }<br class="calibre2"/>    }<br class="calibre2"/><br class="calibre2"/>    # (7) prompt for response message, and input response lines,<br class="calibre2"/>    #     sending response lines to client, until solitary "."<br class="calibre2"/>    printf("    &lt;&lt;&lt;Type Response Followed by '.'&gt;&gt;&gt;\n");<br class="calibre2"/><br class="calibre2"/>    while ($line = &lt;STDIN&gt;)<br class="calibre2"/>    {<br class="calibre2"/>        $line =~ s/\r//;<br class="calibre2"/>        $line =~ s/\n//;<br class="calibre2"/>        if ($line =~ /^\./) { last; }<br class="calibre2"/>        print C $line . "\r\n";<br class="calibre2"/>    }<br class="calibre2"/>    close(C);<br class="calibre2"/>}<br class="calibre2"/></tt></span></blockquote><p class="calibre_22">图 5-2 显示了 Joe 的五金商店的管理员是如何用 type-o-serve 来测试 HTTP 通信的。</p><p class="calibre_8"><img src="images/00003.jpg" class="calibre_90"/></p><p class="calibre_10"><span class="calibre7">图 5-2　type-o-serve 实用程序让用户输入服务器响应，将其回送给客户端</span></p><div class="calibre_5"> </div><ul class="calibre_6"><li value="1" class="calibre_7"><p class="calibre_">首先，管理员启动了 type-o-serve 诊断服务器，在一个特定的端口上监听。由于 Joe 的五金商店已经有一个产品化的 Web 服务器在监听 80 端口了，所以管理员用下面这条命令在端口 8080（可以选择任意未用端口）上启动了 type-o-serve 服务：</p><blockquote class="calibre_21"><span class="calibre7"><tt class="calibre8">% type-o-serve.pl 8080<br class="calibre2"/></tt></span></blockquote></li><li value="2" class="calibre_53"><p class="calibre_">只要 type-o-serve 开始运行了，就可以将浏览器指向这个 Web 服务器。在图 5-2 中，浏览器指向了 <a href="http://www.joes-hardware.com:8080/foo/bar/blah.txt">http://www.joes-hardware.com:8080/foo/bar/blah.txt</a>。</p></li><li value="3" class="calibre_7"><p class="calibre_">type-o-serve 程序收到来自浏览器的 HTTP 请求报文，并将 HTTP 请求报文的内容打印在屏幕上。然后 type-o-serve 诊断工具会等待用户输入一条简单的响应报文，后面跟着只有一个句号的空行。</p></li><li value="4" class="calibre_7"><p class="calibre_">type-o-serve 将 HTTP 响应报文回送给浏览器，浏览器会显示响应报文的主体。 </p></li></ul><div class="mbp_pagebreak" id="calibre_pb_49"></div>
</body></html>
