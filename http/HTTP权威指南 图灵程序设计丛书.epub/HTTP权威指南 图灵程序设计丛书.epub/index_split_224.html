<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>HTTP权威指南 (图灵程序设计丛书)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p class="calibre_"><span class="calibre3"><span class="bold">F.4　参考代码</span></span></p><p class="calibre_">下列代码实现了 RFC 2617 中 H(A1)、H(A2)、request-digest 和 response-digest 的计算。它使用了 RFC 1321 中的 MD5 实现。</p><p class="calibre_"><span class="calibre3"><span class="bold">F.4.1　文件digcalc.h</span></span></p><blockquote class="calibre_21"><span class="calibre7"><tt class="calibre8">#define HASHLEN 16<br class="calibre2"/>typedef char HASH[HASHLEN];<br class="calibre2"/>#define HASHHEXLEN 32<br class="calibre2"/>typedef char HASHHEX[HASHHEXLEN+1];<br class="calibre2"/>#define IN<br class="calibre2"/>#define OUT<br class="calibre2"/>/* calculate H(A1) as per HTTP Digest spec */<br class="calibre2"/>void DigestCalcHA1(<br class="calibre2"/>    IN char * pszAlg,<br class="calibre2"/>    IN char * pszUserName,<br class="calibre2"/>    IN char * pszRealm,<br class="calibre2"/>    IN char * pszPassword,<br class="calibre2"/>    IN char * pszNonce,<br class="calibre2"/>    IN char * pszCNonce,<br class="calibre2"/>    OUT HASHHEX SessionKey<br class="calibre2"/>    );<br class="calibre2"/><br class="calibre2"/>/* calculate request-digest/response-digest as per HTTP Digest spec */<br class="calibre2"/>void DigestCalcResponse(<br class="calibre2"/>    IN HASHHEX HA1, /* H(A1) */<br class="calibre2"/>    IN char * pszNonce, /* nonce from server */<br class="calibre2"/>    IN char * pszNonceCount, /* 8 hex digits */<br class="calibre2"/>    IN char * pszCNonce, /* client nonce */<br class="calibre2"/>    IN char * pszQop, /* qop-value: "", "auth", "auth-int" */<br class="calibre2"/>    IN char * pszMethod, /* method from the request */<br class="calibre2"/>    IN char * pszDigestUri, /* requested URL */<br class="calibre2"/>    IN HASHHEX HEntity, /* H(entity body) if qop="auth-int" */<br class="calibre2"/>    OUT HASHHEX Response /* request-digest or response-digest */<br class="calibre2"/>    );<br class="calibre2"/></tt></span></blockquote><p class="calibre_22"><span class="calibre3"><span class="bold">F.4.2　文件“digcalc.c”</span></span></p><blockquote class="calibre_21"><span class="calibre7"><tt class="calibre8">#include &lt;global.h&gt;<br class="calibre2"/>#include &lt;md5.h&gt;<br class="calibre2"/>#include &lt;string.h&gt;<br class="calibre2"/>#include "digcalc.h"<br class="calibre2"/><br class="calibre2"/>void CvtHex(<br class="calibre2"/>    IN HASH Bin,<br class="calibre2"/>    OUT HASHHEX Hex<br class="calibre2"/>    )<br class="calibre2"/>    {<br class="calibre2"/><br class="calibre2"/>unsigned short i;<br class="calibre2"/>unsigned char j;<br class="calibre2"/>for (i = 0; i &lt; HASHLEN; i++) {<br class="calibre2"/>    j = (Bin[i] &gt;&gt; 4) &amp; 0xf;<br class="calibre2"/>    if (j &lt;= 9)<br class="calibre2"/>        Hex[i*2] = (j + '0');<br class="calibre2"/>    else<br class="calibre2"/>        Hex[i*2] = (j + 'a' - 10);<br class="calibre2"/>    j = Bin[i] &amp; 0xf;<br class="calibre2"/>    if (j &lt;= 9)<br class="calibre2"/>        Hex[i*2+1] = (j + '0');<br class="calibre2"/>    else<br class="calibre2"/>        Hex[i*2+1] = (j + 'a' - 10);<br class="calibre2"/>    };<br class="calibre2"/>    Hex[HASHHEXLEN] = '\0';<br class="calibre2"/>    };<br class="calibre2"/><br class="calibre2"/>/* calculate H(A1) as per spec */<br class="calibre2"/>void DigestCalcHA1(<br class="calibre2"/>    IN char * pszAlg,<br class="calibre2"/>    IN char * pszUserName,<br class="calibre2"/>    IN char * pszRealm,<br class="calibre2"/>    IN char * pszPassword,<br class="calibre2"/>    IN char * pszNonce,<br class="calibre2"/>    IN char * pszCNonce,<br class="calibre2"/>    OUT HASHHEX SessionKey<br class="calibre2"/>    )<br class="calibre2"/>{<br class="calibre2"/>    MD5_CTX Md5Ctx;<br class="calibre2"/>    HASH HA1;<br class="calibre2"/>    MD5Init(&amp;Md5Ctx);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, pszUserName, strlen(pszUserName));<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, pszRealm, strlen(pszRealm));<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, pszPassword, strlen(pszPassword));<br class="calibre2"/>    MD5Final(HA1, &amp;Md5Ctx);<br class="calibre2"/>    if (stricmp(pszAlg, "md5-sess") == 0) {<br class="calibre2"/>        MD5Init(&amp;Md5Ctx);<br class="calibre2"/>        MD5Update(&amp;Md5Ctx, HA1, HASHLEN);<br class="calibre2"/>        MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>        MD5Update(&amp;Md5Ctx, pszNonce, strlen(pszNonce));<br class="calibre2"/>        MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>        MD5Update(&amp;Md5Ctx, pszCNonce, strlen(pszCNonce));<br class="calibre2"/>        MD5Final(HA1, &amp;Md5Ctx);<br class="calibre2"/>    };<br class="calibre2"/>    CvtHex(HA1, SessionKey);<br class="calibre2"/>};<br class="calibre2"/>/* calculate request-digest/response-digest as per HTTP Digest spec */<br class="calibre2"/>void DigestCalcResponse(<br class="calibre2"/>    IN HASHHEX HA1, /* H(A1) */<br class="calibre2"/>    IN char * pszNonce, /* nonce from server */<br class="calibre2"/>    IN char * pszNonceCount, /* 8 hex digits */<br class="calibre2"/>    IN char * pszCNonce, /* client nonce */<br class="calibre2"/>    IN char * pszQop, /* qop-value: "", "auth", "auth-int" */<br class="calibre2"/>    IN char * pszMethod, /* method from the request */<br class="calibre2"/>    IN char * pszDigestUri, /* requested URL */<br class="calibre2"/>    IN HASHHEX HEntity, /* H(entity body) if qop= "auth-int" */<br class="calibre2"/>    OUT HASHHEX Response /* request-digest or response-digest */<br class="calibre2"/>    )<br class="calibre2"/>{<br class="calibre2"/>    MD5_CTX Md5Ctx;<br class="calibre2"/>    HASH HA2;<br class="calibre2"/>    HASH RespHash;<br class="calibre2"/>    HASHHEX HA2Hex;<br class="calibre2"/>    // calculate H(A2)<br class="calibre2"/>    MD5Init(&amp;Md5Ctx);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, pszMethod, strlen(pszMethod));<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, pszDigestUri, strlen(pszDigestUri));<br class="calibre2"/>    if (stricmp(pszQop, "auth-int") == 0) {<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, HEntity, HASHHEXLEN);<br class="calibre2"/>};<br class="calibre2"/>MD5Final(HA2, &amp;Md5Ctx);<br class="calibre2"/>CvtHex(HA2, HA2Hex);<br class="calibre2"/>// calculate response<br class="calibre2"/>MD5Init(&amp;Md5Ctx);<br class="calibre2"/>MD5Update(&amp;Md5Ctx, HA1, HASHHEXLEN);<br class="calibre2"/>MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>MD5Update(&amp;Md5Ctx, pszNonce, strlen(pszNonce));<br class="calibre2"/>MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>if (*pszQop) {<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, pszNonceCount, strlen(pszNonceCount));<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, pszCNonce, strlen(pszCNonce));<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, pszQop, strlen(pszQop));<br class="calibre2"/>       MD5Update(&amp;Md5Ctx, ":", 1);<br class="calibre2"/>    };<br class="calibre2"/>    MD5Update(&amp;Md5Ctx, HA2Hex, HASHHEXLEN);<br class="calibre2"/>    MD5Final(RespHash, &amp;Md5Ctx);<br class="calibre2"/>    CvtHex(RespHash, Response);<br class="calibre2"/>};<br class="calibre2"/></tt></span></blockquote><p class="calibre_22"><span class="calibre3"><span class="bold">F.4.3　文件digtest.c</span></span></p><blockquote class="calibre_21"><span class="calibre7"><tt class="calibre8">#include &lt;stdio.h&gt;<br class="calibre2"/>#include "digcalc.h"<br class="calibre2"/><br class="calibre2"/>void main(int argc, char ** argv) {<br class="calibre2"/>    char * pszNonce = "dcd98b7102dd2f0e8b11d0f600bfb0c093";<br class="calibre2"/>    char * pszCNonce = "0a4f113b";<br class="calibre2"/>    char * pszUser = "Mufasa";<br class="calibre2"/>    char * pszRealm = "testrealm@host.com";<br class="calibre2"/>    char * pszPass = "Circle Of Life";<br class="calibre2"/>    char * pszAlg = "md5";<br class="calibre2"/>    char szNonceCount[9] = "00000001";<br class="calibre2"/>    char * pszMethod = "GET";<br class="calibre2"/>    char * pszQop = "auth";<br class="calibre2"/>    char * pszURI = "/dir/index.html";<br class="calibre2"/>    HASHHEX HA1;<br class="calibre2"/>    HASHHEX HA2 = "";<br class="calibre2"/>    HASHHEX Response;<br class="calibre2"/>    DigestCalcHA1(pszAlg, pszUser, pszRealm, pszPass,<br class="calibre2"/>        pszNonce, pszCNonce, HA1);<br class="calibre2"/>        DigestCalcResponse(HA1, pszNonce, szNonceCount, pszCNonce, pszQop,<br class="calibre2"/>        pszMethod, pszURI, HA2, Response);<br class="calibre2"/>    printf("Response = %s\n", Response);<br class="calibre2"/>}; <br class="calibre2"/></tt></span></blockquote><p class="calibre2" style="margin:0pt; border:0pt; height:1em"> </p><div class="mbp_pagebreak" id="calibre_pb_224"></div>
</body></html>
